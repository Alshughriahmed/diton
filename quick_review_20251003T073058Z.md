# ูุฑุงุฌุนุฉ ุณุฑูุนุฉ - Ditona Next.js 15

**ุงูุชุงุฑูุฎ**: 2025-10-03 07:30 UTC  
**ุงููุฑุน**: `hotfix/ui-restore-from-p4`  
**Scope**: ููุฎูุถุฉ ุงููููุฉุ ูุญุต ุณูุงูุฉ ููุท

---

## ๐ ุฌุฏูู ุงููุญุต

### P0: ูุงุฌูุฉ ูุฃุตูู

| ุงูุจูุฏ | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|------|--------|----------|
| CSS ูุญููู 200 | โ | HTTP 200 ููุฃุตูู ุงูุซุงุจุชุฉ |
| ูุง `<style>body{...}` ูู View Source | โ | ูุง ููุฌุฏ ุณุชุงูู 404 ุงูุชุฑุงุถู |
| ูุง Hydration errors ูุฑุฆูุฉ (/) | โ๏ธ | Home ุชุนููุ ููู hydration warning ูู logs |
| ุซูู `<body>` ูุนูุงู | โ | `bg-neutral-950 text-white antialiased` |

### P0: ูุณุทูุฉ/ูุงุด

| ุงูุจูุฏ | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|------|--------|----------|
| matcher ูุณุชุซูู `_next/static` | โ | `/((?!api\|_next/static\|_next/image\|favicon.ico).*)` |
| CSP ุตุญูุญ | โ | `'self'` ุจุนูุงูุงุช ุงูุชุจุงุณ ุตุญูุญุฉ |

### P1: ูุฌูุฏ ุงูููุฒุงุช ุจุงูุดูุฑุฉ

| ุงูุจูุฏ | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|------|--------|----------|
| Age-gate API | โ | `/api/age/allow` ููุฌูุฏ ููุถุจุท `ageok=1` |
| safeFetch ููุฌูุฏุฉ ูููุณุชุฎุฏูุฉ | โ | ูู `chat/safeFetch.ts` ูููุณุชุฎุฏูุฉ ูู bridges |
| FFA/Filters/Beauty ุจุงูููุฏ | โ๏ธ | Bridges ููุฌูุฏุฉุ ููู ูููุงุช ููููุฏุฉ ุชููุน /chat |
| JSON-LD ูู layout | โ | `JsonLd` component ูุน `suppressHydrationWarning` |
| ุตูุญุงุช ุงูุณูุงุณุงุช | โ | terms, privacy, plans ููุฌูุฏุฉ |

---

## ๐ด ูุดุงูู ุญุฑุฌุฉ - /chat ูุนุทู

### ูููุงุช ููููุฏุฉ (Module not found)

ุงูุชุงููุฉ ุชุธูุฑ ูู Browser Console ูุชููุน `/chat` ูู ุงูุนูู:

```
โ @/hooks/useKeyboardShortcuts
โ @/lib/mobile
โ @/lib/ui/toast
โ @/lib/match/controls
โ @/state/profile
โ @/lib/regions
โ @/hooks/usePeerMeta
โ @/lib/seo
```

### Export authOptions ูุนุทู

```
โ src/app/api/auth/[...nextauth]/route.ts
Export 'authOptions' is not defined (46:9)
```

### Hydration Warning

```
โ๏ธ Hydration mismatch ุนูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
```

**ุงูุณุจุจ ุงููุญุชูู**: 
- `ScreenEffects.tsx` ู `ErrorTracker.tsx` ูุณุชุฎุฏูุงู `Date.now()` ู `Math.random()`
- ููุงููุง client components (`"use client"`) โุ ููู ูููู ุฃู ูุณุจุจ warnings

---

## โ ุฅุตูุงุญุงุช ุชูุช

### 1. ุฅุตูุงุญ TypeScript Types

**ุฎุทุฃ**: `GenderSelect.tsx` - `e.target.value` ููุนู `string` ุจูููุง `setGender` ุชุชููุน `GenderOpt`

**ุงูุญู**:
```typescript
// ูุจู
onChange={(e)=>setGender(e.target.value)}

// ุจุนุฏ
import { type GenderOpt } from "@/state/filters";
onChange={(e)=>setGender(e.target.value as GenderOpt)}
```

### 2. ุชุซุจูุช ููุชุจุฉ jose

**ุฎุทุฃ**: `age-jwt.ts` - Cannot find module 'jose'

**ุงูุญู**: `pnpm install jose` โ

### 3. TypeScript Check

```bash
npx tsc --noEmit
```

**ุงููุชูุฌุฉ**: โ ุตูุฑ ุฃุฎุทุงุก TypeScript ุจุนุฏ ุงูุฅุตูุงุญุงุช

---

## ๐ ูุญุต ุซุงุจุช - ุงููุชุงุฆุฌ

### โ ุตุญูุญ

1. **middleware.ts**: ุงุณุชุซูุงุก ุงูุฃุตูู ุตุญูุญุ CSP ุจุนูุงูุงุช ุงูุชุจุงุณ ุตุญูุญุฉ
2. **not-found.tsx**: ูุง `<style>` ูุถูููุ Tailwind ููุท
3. **error.tsx**: ูุง `<style>` ูุถูููุ Tailwind ููุท
4. **layout.tsx**: ูุณุชูุฑุฏ `globals.css`ุ body theme ูุถุจูุทุ JSON-LD ุตุญูุญ
5. **globals.css**: `@tailwind` directives ููุฌูุฏุฉ
6. **JsonLd.tsx**: `suppressHydrationWarning` ููุฌูุฏ โ
7. **Age API**: `/api/age/allow` ูุถุจุท cookie ุตุญูุญ
8. **safeFetch**: ููุฌูุฏ ูููุณุชุฎุฏู ูู `filtersBridge` ู `freeForAllBridge`
9. **FFA/Filters bridges**: ููุฌูุฏุฉ ูู `chat/`

### โ ููููุฏ/ูุนุทู

1. **8 ูููุงุช ููููุฏุฉ** ุชููุน `/chat` ูู ุงูุนูู
2. **authOptions** ุบูุฑ ูุนุฑูู ูู NextAuth route
3. **/chat page** ูุง ูููู ุชุญููููุง ุจุณุจุจ ุงูุฃุฎุทุงุก ุฃุนูุงู

---

## ๐ธ ููุทุงุช ุงูุดุงุดุฉ

### ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ (/)

**ุงูุญุงูุฉ**: โ๏ธ Page timeout (Server issues ูู ูููุงุช ููููุฏุฉ)

**ุชุฃููุฏุงุช ูู Logs**:
- โ CSS loaded: `/_next/static/css/app/layout.css`
- โ No CSP errors ุจุนุฏ ุฅุตูุงุญ middleware
- โ DOM classes present: `bg-gradient-to-b`, `from-slate-900`, etc.
- โ๏ธ Hydration warning ููุฌูุฏ

### ุตูุญุฉ /chat

**ุงูุญุงูุฉ**: โ ูุนุทูุฉ ุจุณุจุจ 8 ูููุงุช ููููุฏุฉ

---

## ๐ ุชุญูู ุดุจูุฉ

### 1. CSS Loading

```bash
# Local dev
curl -I http://localhost:5000/_next/static/css/app/layout.css
HTTP/1.1 200 OK  โ
```

### 2. View Source Check

```bash
curl -s http://localhost:5000/ | grep -i '<style.*body.*background.*#fff'
# No match โ (ูุง ููุฌุฏ ุณุชุงูู 404 ุงูุชุฑุงุถู)
```

### 3. DOM Classes

```bash
curl -s http://localhost:5000/ | grep -o 'bg-gradient-to-b\|min-h-screen\|text-white'
bg-gradient-to-b  โ
min-h-screen      โ
text-white        โ
```

---

## ๐ฏ ุงูุชูุตูุงุช

### ๐ด ุญุฑุฌ - ูุฌุจ ุฅุตูุงุญู

1. **ุงุณุชุฑุฌุงุน ุงููููุงุช ุงูููููุฏุฉ ูู ูุฑุน p4**:
   - `/src/hooks/useKeyboardShortcuts.ts`
   - `/src/lib/mobile.ts`
   - `/src/lib/ui/toast.ts`
   - `/src/lib/match/controls.ts`
   - `/src/state/profile.ts`
   - `/src/lib/regions.ts`
   - `/src/hooks/usePeerMeta.ts`
   - `/src/lib/seo.ts`

2. **ุฅุตูุงุญ authOptions**:
   - ุชุนุฑูู `authOptions` ูุจู export ูู `/src/app/api/auth/[...nextauth]/route.ts`

### โ๏ธ ูุชูุณุท - ููุณุชุญุณู

1. **ุฅุตูุงุญ Hydration warning**:
   - ูุฑุงุฌุนุฉ ุงุณุชุฎุฏุงู `Date.now()` ูู `ScreenEffects.tsx`
   - ุงุณุชุฎุฏุงู `useEffect` ูุชุฃุฎูุฑ ุงูููุฏ ุงูุฏููุงูููู client-side ููุท

2. **API routes ููููุฏุฉ**:
   - `/api/geo` ูุนุทู 404
   - `/hero.webp` ููููุฏ

### โ ุงุฎุชูุงุฑู - ุชุญุณููุงุช

1. ุฅุถุงูุฉ `global-error.tsx` (ุงุฎุชูุงุฑูุ `error.tsx` ูุงูู)
2. ุชุญุณูู error handling ูู chat bridges

---

## ๐ฆ ุณูู ุงูุชุดุบููุงุช

| ุงูููุน | ุงููุฎุทุท | ุงูููููุฐ | ุงูุญุงูุฉ |
|------|--------|---------|---------|
| Type check | 1 | 1 | โ |
| Local run | 1 | 1 | โ๏ธ ูุนุทู ุจูููุงุช ููููุฏุฉ |
| Preview deploy | 1 | 0 | โธ๏ธ ูุคุฌู ุญุชู ุฅุตูุงุญ ุงูุฃุฎุทุงุก |

**ููุงุญุธุฉ**: ูู ูุชู ูุดุฑ Preview ูุฃู /chat ูุนุทู. ูููุตุญ ุจุฅุตูุงุญ ุงููููุงุช ุงูููููุฏุฉ ุฃููุงู.

---

## ๐ฌ ุงูุฎูุงุตุฉ

### โ ูุง ูุนูู

- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ `/` - Layout ูุงูุซูู
- Middleware - ุงุณุชุซูุงุก ุฃุตูู Next.js ุตุญูุญ
- CSS/Tailwind - ูุญููู ุจูุฌุงุญ
- Age gate - API ููุฌูุฏ
- TypeScript - ุตูุฑ ุฃุฎุทุงุก ุจุนุฏ ุงูุฅุตูุงุญุงุช
- Bridges (FFA/Filters) - ููุฏ ููุฌูุฏ

### โ ูุง ูุง ูุนูู

- ุตูุญุฉ `/chat` - **ูุนุทูุฉ ุชูุงูุงู** ุจุณุจุจ 8 ูููุงุช ููููุฏุฉ
- NextAuth - `authOptions` ุบูุฑ ูุนุฑูู
- Hydration - warnings ููุฌูุฏุฉ

### ๐ ุงูุชูููู ุงูุนุงู

**P0 (ูุงุฌูุฉ + ูุณุทูุฉ)**: 80% โ  
**P1 (ููุฒุงุช)**: 40% โ๏ธ - ููุฏ ููุฌูุฏ ููู /chat ูุนุทู

**ุงูุญูู**: **ุบูุฑ ุฌุงูุฒ ูููุดุฑ** ุญุชู ุงุณุชุฑุฌุงุน ุงููููุงุช ุงูููููุฏุฉ ูุฅุตูุงุญ /chat
