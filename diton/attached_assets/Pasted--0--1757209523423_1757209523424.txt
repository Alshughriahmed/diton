Ø³Ø£Ù†ÙÙ‘Ø° Ù…Ù‡Ù…Ø© ØµØºÙŠØ±Ø© Ø¯Ù‚ÙŠÙ‚Ø© (Ø¨Ø¯ÙˆÙ† ØªØ¨Ø¹ÙŠØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©) Ù…Ø¹ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆÙØ­ÙˆØµ Ù‚Ø¨ÙˆÙ„.

# 0) Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø±ÙŠØ¹Ø©
STAMP="$(date -u +%Y%m%d-%H%M%S)"
BK="_ops/backups/chat_dyn_emoji_${STAMP}.tgz"
mkdir -p _ops/backups && tar -czf "$BK" --exclude=node_modules --exclude=.next .

# 1) Ø¥Ø¬Ø¨Ø§Ø± /chat Ø£Ù† ØªÙƒÙˆÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ù…Ù†Ø¹ Ø£ÙŠ ÙƒØ§Ø´ ÙŠØªØ¬Ø§ÙˆØ² Ø¨ÙˆØ§Ø¨Ø© +18)
# Ø£) Ø¥Ù† ÙˆÙØ¬Ø¯ src/app/chat/page.tsx Ø£Ø¶Ù ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù:
#    export const dynamic = 'force-dynamic'; export const revalidate = 0;
# Ø¨) Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ page.tsx ÙˆØ£ÙØ¯ÙŠØ±Øª Ù…Ù† layout.tsx ÙØ£Ø¶Ù Ø§Ù„Ø³Ø·Ø±ÙŠÙ† ÙÙŠ src/app/chat/layout.tsx
apply_dynamic(){
  f1="src/app/chat/page.tsx"; f2="src/app/chat/layout.tsx"
  if [ -f "$f1" ]; then
    grep -q "dynamic = 'force-dynamic'" "$f1" || \
      sed -i "1iexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n" "$f1"
  elif [ -f "$f2" ]; then
    grep -q "dynamic = 'force-dynamic'" "$f2" || \
      sed -i "1iexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n" "$f2"
  fi
}
apply_dynamic

# 2) ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© + Ø¥Ø¶Ø§ÙØ© Ù…ÙØ¹Ø±Ù‘ÙØ§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
# Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒÙˆÙ‘Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ØºØ§Ù„Ø¨Ø§Ù‹ Ø¯Ø§Ø®Ù„ src/app/chat/ChatClient.tsx Ø£Ùˆ src/components/chat/*)
# ÙˆØ§Ø³ØªØ¨Ø¯Ù„ placeholder Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ù€ Type a messageâ€¦ ÙˆØ£Ø¶Ù data-testid="chat-input"
set_placeholder(){
  for f in src/app/chat/ChatClient.tsx src/components/chat/*.tsx; do
    [ -f "$f" ] || continue
    sed -i "s/Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©/Type a messageâ€¦/g" "$f"
    grep -q 'data-testid="chat-input"' "$f" || \
      sed -i "s/placeholder=\(\"[^\"]*\"\\|{\[^}]*}\)/data-testid=\"chat-input\" placeholder=\1/" "$f"
  done
}
set_placeholder

# 3) Ø¥Ù†Ø´Ø§Ø¡ Emoji Picker Ø®ÙÙŠÙ ÙˆØ±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ù‡ (Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª)
# - Ù…ÙƒÙˆÙ‘Ù† Ø¨Ø³ÙŠØ· Ø´Ø¨ÙƒØ© 48 Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø´Ø§Ø¦Ø¹Ø©
# - Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙŠÙØ¯Ø±ÙØ¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
# - data-testid="emoji-button" Ùˆ data-testid="emoji-panel" Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
cat > src/components/chat/EmojiPicker.tsx <<'TSX'
"use client";
import React from "react";
const EMOJIS = "ğŸ˜€ğŸ˜„ğŸ˜ğŸ˜†ğŸ¥¹ğŸ˜ŠğŸ™‚ğŸ˜‰ğŸ˜ğŸ˜˜ğŸ˜œğŸ¤ªğŸ¤—ğŸ¤”ğŸ¤¨ğŸ˜ğŸ˜´ğŸ¥³ğŸ¤©ğŸ˜ğŸ˜‡ğŸ˜­ğŸ˜¤ğŸ˜¡ğŸ‘ğŸ‘ğŸ‘ğŸ™ğŸ’ªğŸ”¥âœ¨ğŸ‰â¤ï¸ğŸ§¡ğŸ’›ğŸ’šğŸ’™ğŸ’œğŸ–¤ğŸ¤ğŸ’¯âœ…âŒ".split("");
export default function EmojiPicker({ onPick }: { onPick: (e: string)=>void }) {
  return (
    <div data-testid="emoji-panel" className="absolute bottom-14 left-2 z-50 grid grid-cols-8 gap-2 p-2 rounded-2xl bg-neutral-900/95 shadow-lg border border-neutral-700">
      {EMOJIS.map((e, i)=>(
        <button key={i} onClick={()=>onPick(e)} className="text-xl hover:scale-110 transition" aria-label={`emoji ${e}`}>{e}</button>
      ))}
    </div>
  );
}
TSX

# 4) ØªÙˆØµÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†:
# - ÙÙŠ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:
#   * Ø£Ø¶Ù useState Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø©
#   * Ø§Ø­ØªÙØ¸ Ø¨Ù€ ref Ù„Ù„Ù€ textarea/input Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±
wire_emoji(){
  target="src/app/chat/ChatClient.tsx"
  [ -f "$target" ] || target=$(ls src/components/chat/*Toolbar*.tsx 2>/dev/null | head -n1)
  [ -f "$target" ] || return 0
  # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯
  grep -q "EmojiPicker" "$target" || sed -i "1i import EmojiPicker from \"@/components/chat/EmojiPicker\";\nimport { useRef, useState } from \"react\";" "$target"
  # Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© ÙˆÙ…Ø±Ø¬Ø¹ Ù„Ù„Ø­Ù‚Ù„
  grep -q "const \\[showEmoji" "$target" || sed -i "s/function ChatClient/function ChatClient/" "$target"
  grep -q "showEmoji" "$target" || sed -i "0,/return/s//const inputRef = useRef<HTMLTextAreaElement|HTMLInputElement|null>(null);\nconst [showEmoji,setShowEmoji]=useState(false);\nreturn/" "$target"
  # ÙˆØ³Ù… Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  sed -i '0,/\<button[^\n]*emoji/s//& data-testid="emoji-button" onClick={(e)=>{e.preventDefault(); setShowEmoji(v=>!v);}}/' "$target" || true
  # ÙˆØ³Ù… Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¬Ø¹
  sed -i '0,/<textarea/ s//<textarea ref={inputRef} /' "$target" || sed -i '0,/<input[^>]*type="text"/ s//<input type="text" ref={inputRef} /' "$target"
  # Ø­Ù‚Ù† Ø§Ù„Ù€ EmojiPicker Ø£Ø³ÙÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  grep -q "EmojiPicker" "$target" || \
  sed -i '0,/<\/form>\|<\/div>\|<\/section>/s//{showEmoji && <EmojiPicker onPick={(e)=>{const el=inputRef.current; if(!el) return; const s=(el as any).selectionStart||el.value.length; const t=(el as any).selectionEnd||s; el.value = el.value.slice(0,s)+e+el.value.slice(t); (el as any).selectionStart=(el as any).selectionEnd=s+e.length; el.dispatchEvent(new Event("input",{bubbles:true})); setShowEmoji(false);}} />}\n&/' "$target"
}
wire_emoji

# 5) ØªØ´ØºÙŠÙ„ dev Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆÙØ­ÙˆØµ Ù‚Ø¨ÙˆÙ„ Ø³Ø±ÙŠØ¹Ø©
pkill -f "next.*dev" 2>/dev/null || true
( PORT=3000 pnpm dev >/tmp/app.log 2>&1 & ) ; sleep 6
ORIGIN="http://127.0.0.1:3000"
COOKIE=/tmp/c.txt; :> "$COOKIE"
CHAT1=$(curl -s -D - -o /dev/null "$ORIGIN/chat" | awk 'NR==1{print $2}')
curl -s -X POST -c "$COOKIE" "$ORIGIN/api/age/allow" >/dev/null
CHAT2=$(curl -s -o /dev/null -w "%{http_code}" -b "$COOKIE" "$ORIGIN/chat")
PP=$(curl -sI -b "$COOKIE" "$ORIGIN/chat" | awk 'BEGIN{IGNORECASE=1}/^Permissions-Policy:/{sub(/\r$/,"");print}')
HTML=$(curl -s "$ORIGIN/")
CSS=$(echo "$HTML" | grep -oE "/_next/static/css/[^\"']+\\.css" | head -1)
PLH=$(echo "$HTML" | grep -o "Type a messageâ€¦" || true)
PANEL_TAG=$(grep -Rni 'data-testid=\"emoji-panel\"' src | wc -l)

echo "-- Acceptance --"
echo "AGE_FLOW=$CHAT1->$CHAT2"
echo "PERMISSIONS_POLICY=${PP}"
echo "CSS_LINK=$([ -n "$CSS" ] && echo 1 || echo 0)"
echo "PLACEHOLDER=$([ -n "$PLH" ] && echo ok || echo missing)"
echo "EMOJI_WIRED=$([ "$PANEL_TAG" -gt 0 ] && echo yes || echo no)"
echo "LOG=/tmp/app.log BK=$BK"
echo "-- End Acceptance --"
