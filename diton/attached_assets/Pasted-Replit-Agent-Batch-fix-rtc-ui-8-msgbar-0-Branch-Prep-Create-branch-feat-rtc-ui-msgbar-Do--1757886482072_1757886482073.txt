Replit Agent â€” Batch: fix-rtc-ui-8 + msgbar
0) Branch & Prep

Create branch: feat/rtc-ui-msgbar

Do not touch visual design except Ù…Ø§ ÙˆØ±Ø¯ Ø£Ø¯Ù†Ø§Ù‡.

Keep all RTC logicØ› Ù†Ø¶ÙŠÙ Ø­Ø±Ø§Ø³Ø§Øª ÙˆØ£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·.

1) Auto-start + Rematch Ø«Ø§Ø¨Øª (rtcFlow)

Edit: src/app/chat/rtcFlow.ts

Goals

ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§.

stop() ØªÙÙ†Ø¸Ù‘Ù pollers ÙˆØªØ¹ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ idle.

next() ÙŠÙˆÙ‚Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø«Ù… ÙŠØ¹Ø§ÙˆØ¯ start() Ù…Ø¹ ØªØ¨Ø±ÙŠØ¯ 700ms.

Ø¨Ø«Ù‘ Ø£Ø­Ø¯Ø§Ø« Ø®ÙÙŠÙØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©:
window.dispatchEvent(new CustomEvent('rtc:phase',{detail:{phase,role}}))
window.dispatchEvent(new CustomEvent('rtc:pair',{detail:{pairId,role}}))
window.dispatchEvent(new CustomEvent('rtc:remote-track',{detail:{stream}}))

Patch (Ø£Ø¶ÙÙ/Ø¹Ø¯Ù‘Ù„ Ø¨Ø§Ù‚ØªØ¶Ø§Ø¨):

// + Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
const sleep = (ms:number)=>new Promise(r=>setTimeout(r,ms));
let cooldownNext = false;

// Ø¯Ø§Ø®Ù„ start(): Ø£ÙˆÙ„ Ø³Ø·Ø±
window.dispatchEvent(new CustomEvent('rtc:phase',{detail:{phase:'searching',role:null}}));

// Ø¨Ø¹Ø¯ matchmake OK:
localStorage.setItem('ditona_pair', pairId);
localStorage.setItem('ditona_role', role);
window.dispatchEvent(new CustomEvent('rtc:pair',{detail:{pairId,role}}));
window.dispatchEvent(new CustomEvent('rtc:phase',{detail:{phase:'matched',role}}));

// ÙÙŠ ontrack Ù„Ø£ÙˆÙ„ Ù…Ø±Ù‘Ø© Ù„ÙƒÙ„ stream:
window.dispatchEvent(new CustomEvent('rtc:remote-track',{detail:{stream:e.streams[0]}}));
window.dispatchEvent(new CustomEvent('rtc:phase',{detail:{phase:'connected',role:state.role}}));

// ÙÙŠ stop()/cleanup():
window.dispatchEvent(new CustomEvent('rtc:phase',{detail:{phase:'idle',role:null}}));

// new method:
export async function next(){
  if(cooldownNext) return;
  cooldownNext = true;
  try{ await stop(); await sleep(700); await start(); }
  finally{ cooldownNext = false; }
}

2) ChatClient: Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« + ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø±Ù

Edit: src/app/chat/ChatClient.tsx

Goals

ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ getUserMedia() Ù…Ø¨Ø§Ø´Ø±Ø©.

ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ø³Ù…/Ø£ÙØ§ØªØ§Ø±/Ù„Ø§ÙŠÙƒØ§Øª) ÙˆBadges (Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø¬Ù†Ø³) Ø¹Ù†Ø¯ rtc:pair.

Ø¥Ø¨Ø±Ø§Ø² Ø¹Ø¨Ø§Ø±Ø© â€œSearching for a partnerâ€¦â€ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ phase=searching Ù…Ø¹ Ø²Ø± Cancel.

Next/Prev ØªÙ„ØªØ²Ù… Ø¨Ø§Ù„ØªØ¨Ø±ÙŠØ¯ 700ms. Prev = VIP ÙÙ‚Ø· (Tooltip).

Ù„Ø§ ØªÙØ·ÙØ£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Next: Ù„Ø§ ØªØ³ØªØ¯Ø¹Ù getUserMedia Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ ÙØ´Ù„.

Patch (Ù…Ø®ØªØµØ±):

// + imports
import * as rtc from '@/app/chat/rtcFlow';
import { useEffect, useRef, useState } from 'react';

const [phase, setPhase] = useState<'idle'|'searching'|'matched'|'connected'>('idle');
const [pair, setPair] = useState<{id?:string, role?:'caller'|'callee'}>({});
const [remoteInfo, setRemoteInfo] = useState<{name?:string; likes?:number; country?:string; city?:string; gender?:string}>({});

useEffect(() => {
  const onPhase = (e:any)=>setPhase(e.detail?.phase);
  const onPair  = (e:any)=>{ setPair({id:e.detail?.pairId, role:e.detail?.role}); /* TODO: fetch remote profile by pairId */ };
  const onTrack = (e:any)=>{ remoteVideoRef.current!.srcObject = e.detail.stream; };
  addEventListener('rtc:phase', onPhase);
  addEventListener('rtc:pair', onPair);
  addEventListener('rtc:remote-track', onTrack);
  return ()=>{ removeEventListener('rtc:phase', onPhase); removeEventListener('rtc:pair', onPair); removeEventListener('rtc:remote-track', onTrack); };
}, []);

useEffect(() => {
  (async () => {
    const s = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideoRef.current!.srcObject = s;
    await rtc.start(); // auto-match
  })().catch(()=>{/* show permission hint */});
}, []);

const onNext = () => rtc.next();


Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±Ù (remoteInfo) ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ØµØ¯Ø± Ù…ØªØ§Ø­ Ù„Ø¯ÙŠÙƒ (Ø¥Ù† ÙˆØ¬Ø¯). Ø§Ø¨Ø¯Ø£ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¨ØªÙ…Ù‡ÙŠØ¯ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¨Ù„Ø¯ Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ peerAnonId Ø¥Ù† Ù…ØªØ§Ø­.

3) ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆVIP-Prev

Edit: src/app/chat/components/ChatToolbar.tsx

Ø§Ø¬Ø¹Ù„ Prev Ù…ØºÙ„Ù‚Ù‹Ø§ Ù„ØºÙŠØ± VIP Ù…Ø¹ Tooltip.

Next ÙŠØ³ØªØ¯Ø¹ÙŠ rtc.next() ÙÙ‚Ø·.

Ù„Ø§ ØªÙˆÙ‚Ù Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠØ©.

<Button onClick={()=>rtc.next()} /* next */ />
<Button disabled={!isVip} title={isVip?'':'VIP only'} /* prev */ />

4) Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ â€” Ø¸Ù‡ÙˆØ±/Ø§Ø®ØªÙØ§Ø¡ ÙˆØ²ÙŠ-Ø¥Ù†Ø¯ÙƒØ³ ÙˆØ±ÙØ¹ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯

Edit: src/app/chat/components/ChatMessagingBar.tsx

Goals

Ø§Ù„Ø´Ø±ÙŠØ· Ù…ÙØ±ÙƒØ¨ Ø¯Ø§Ø¦Ù…Ù‹Ø§Ø› ÙŠÙØ¸Ù‡Ø±/ÙŠØ®ÙÙŠ Ø¨Ù€ CSS (translate/opacity).

ÙŠØºØ·ÙŠ Ø²Ø±ÙŠ â­/â® ØªÙ…Ø§Ù…Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ (z-[70]).

Ø¯Ø±Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø­Ø§ÙˆÙŠØ© absolute bottom-full.

Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙŠØ±ÙØ¹ Ù†ÙØ³Ù‡ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… visualViewport.

Patch Ù…Ø®ØªØµØ±:

const [open,setOpen]=useState(false);
useEffect(()=>{
  const t=()=>setOpen(o=>o); // placeholder
  const onToggle=()=>setOpen(v=>!v);
  addEventListener('msgbar:toggle', onToggle);
  return ()=>removeEventListener('msgbar:toggle', onToggle);
},[]);

<div className={`fixed left-0 right-0 transition-all duration-200 z-[70] ${open?'opacity-100 translate-y-0':'opacity-0 translate-y-6 pointer-events-none'}`}
     style={{bottom:`calc(env(safe-area-inset-bottom) + ${kb}px)`}}>
  {/* input + send(â¤) right, emoji ğŸ™‚ left */}
</div>

useEffect(()=>{
  if(!('visualViewport'in window)) return;
  const vv=(window as any).visualViewport;
  const h=()=>setKb(Math.max(0, Math.round((vv.height - window.innerHeight)*-1)));
  vv.addEventListener('resize',h); vv.addEventListener('scroll',h);
  return ()=>{vv.removeEventListener('resize',h); vv.removeEventListener('scroll',h);};
},[]);


Edit: src/app/chat/components/ChatToolbar.tsx
Ø²Ø± ğŸ’¬ ÙŠØ·Ù„Ù‚: window.dispatchEvent(new CustomEvent('msgbar:toggle')).

5) Like Ø§Ù„ØµØ­ÙŠØ­ (Ù„ÙƒÙ„ pairId) + ØªØ²Ø§Ù…Ù† Ù…Ø¨Ø³Ù‘Ø·

New: src/app/api/like/route.ts (Upstash REST)

POST {pairId, action:'like'|'unlike'} Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… anonId Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠ.
ÙŠØ®Ø²Ù†:

HINCRBY like:<pairId> count <Â±1> (bounded â‰¥0)

SADD like:<pairId>:who <anonId> Ø£Ùˆ SREM

GET ?pairId=â€¦ ÙŠØ±Ø¬Ù‘Ø¹ {count, mine:true|false}.

import { NextResponse } from 'next/server';
const U = process.env.UPSTASH_REDIS_REST_URL!;
const T = process.env.UPSTASH_REDIS_REST_TOKEN!;

async function upstash(cmd:any[]){
  const res = await fetch(U,{method:'POST',headers:{Authorization:`Bearer ${T}`,'Content-Type':'application/json'},body:JSON.stringify([cmd])});
  return res.ok ? (await res.json())[0].result : null;
}
export async function GET(req:Request){
  const {searchParams}=new URL(req.url); const pairId=searchParams.get('pairId')||'';
  const [c,m] = await Promise.all([
    upstash(['HGET',`like:${pairId}`,'count']).then(x=>Number(x||0)),
    upstash(['SISMEMBER',`like:${pairId}:who`, req.headers.get('cookie')||'anon'])
  ]);
  return NextResponse.json({count:c, mine:!!m});
}
export async function POST(req:Request){
  const {pairId,action}=await req.json(); const who=(req.headers.get('cookie')||'anon').slice(0,64);
  let c = Number(await upstash(['HGET',`like:${pairId}`,'count']))||0;
  if(action==='like'){ await upstash(['SADD',`like:${pairId}:who`,who]); c++; }
  if(action==='unlike'){ await upstash(['SREM',`like:${pairId}:who`,who]); c=Math.max(0,c-1); }
  await upstash(['HSET',`like:${pairId}`,'count',String(c)]);
  return NextResponse.json({ok:true,count:c});
}


Client (ChatClient/LikeButton):

Ø¹Ù†Ø¯ rtc:pair Ø§Ø¨Ø¯Ø£ polling ÙƒÙ„ 2s: GET /api/like?pairId=... Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯.

Ø²Ø± â¤ï¸ ÙŠØ±Ø³Ù„ POST /api/like Ù…Ø¹ pairId Ùˆlike/unlike ÙˆÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙˆØ±Ù‹Ø§ (optimistic).

6) Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª (z-index) ÙˆØ§Ù„ØªØºØ·ÙŠØ©

Edit: src/styles/globals.css (Ø£Ùˆ Ù…Ù„Ù Tailwind config)

/* ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª */
:root { --z-toolbar:60; --z-msgbar:70; }


Ø·Ø¨Ù‘Ù‚ z-[var(--z-toolbar)] Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠØŒ Ùˆz-[var(--z-msgbar)] Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.

7) Ø­Ø±Ø³ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª (Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯/Ù…ØªØµÙØ­ÙŠÙ†)

Edit: src/app/chat/ChatClient.tsx

Ù‚Ø¨Ù„ getUserMedia Ø§Ø¹Ù…Ù„ probe Ø³Ø±ÙŠØ¹: Ø¥Ù† ÙƒØ§Ù† document.visibilityState!=='visible' Ø£Ùˆ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± â€œÙ†Ø´Ù‘Ø·â€ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø£Ø¸Ù‡Ø± Hint: â€œÙ‚Ù… Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø£Ùˆ Ø§Ø³Ù…Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€.

(Ù†Øµ ÙÙ‚Ø·ØŒ Ù„Ø§ Ù…Ù†Ø·Ù‚ Ø«Ù‚ÙŠÙ„.)

8) ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„/Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø³Ø¨Ø§Ù‚Ø§Øª

Ø§Ø¬Ø¹Ù„ ÙƒÙ„ Handlers (Next, Cancel, Ø²Ø± ğŸ’¬) ØªØ¹ØªÙ…Ø¯ disabled Ø£Ø«Ù†Ø§Ø¡ cooldownNext Ø£Ùˆ phase==='searching' && !Cancel.

Ù„Ø§ ØªÙØ±Ø³Ù„ enqueue Ø«Ø§Ù†ÙŠØ© Ù…Ø§ Ø¯Ø§Ù… phase==='searching'.

9) Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¨ÙˆÙ„

New: _ops/acc_like.sh

#!/usr/bin/env bash
set -euo pipefail
B="${1:?BASE}"
PID="acc-$(date +%s)"
out1="$(curl -sS "$B/api/like?pairId=$PID")"
p1="$(echo "$out1"|sed -n 's/.*"count":\([0-9]\+\).*/\1/p')"
curl -sS -X POST "$B/api/like" -H 'content-type: application/json' -d "{\"pairId\":\"$PID\",\"action\":\"like\"}" >/dev/null
out2="$(curl -sS "$B/api/like?pairId=$PID")"
p2="$(echo "$out2"|sed -n 's/.*"count":\([0-9]\+\).*/\1/p')"
echo "-- Acceptance --"
echo "LIKE_INC_OK=$([ "$p2" -eq $((p1+1)) ] && echo 1 || echo 0)"
echo "-- End Acceptance --"


Run (by agent):

Build: pnpm build

Dev smoke: pnpm dev (ensure /chat Ø¨Ù„Ø§ Ø£Ø®Ø·Ø§Ø¡)

Accept:

bash _ops/acc_rtc.sh https://www.ditonachat.com â†’ ÙŠØ¬Ø¨ Ø¨Ù‚Ø§Ø¡ PAIR_ID_MATCH=1, NO_403_ON_RTC=1

bash _ops/acc_metrics.sh https://www.ditonachat.com â†’ METRICS_API_OK=true

bash _ops/acc_like.sh https://www.ditonachat.com â†’ LIKE_INC_OK=1

Expected Results (100%)

ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ù…Ø¹ â€œSearchingâ€¦â€ ÙˆØ²Ø± Cancel.

Next Ù„Ø§ ÙŠØ·ÙØ¦ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Ø› ÙŠÙ†ØªÙ‚Ù„ Ø¨Ø«Ø¨Ø§Øª Ø¨Ø¹Ø¯ 700ms.

ØªØªØ­Ø¯Ù‘Ø« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø±Ù (Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª/Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ø¬Ù†Ø³) Ù…Ø¹ ÙƒÙ„ pair.

Ø¹Ø¯Ø§Ø¯ â¤ï¸ Ù…Ø±ØªØ¨Ø· Ø¨Ù€ pairIdØŒ ÙŠØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†.

Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠØ¸Ù‡Ø±/ÙŠØºØ·ÙŠ â­/â® ÙˆÙŠØ¹Ù„Ùˆ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ÙˆÙŠØ®ØªÙÙŠ Ø¨Ø§Ù„ØªØ¨Ø¯ÙŠÙ„.

Ù„Ø§ Ø³Ø¨Ø§Ù‚Ø§Øª: Ù„Ø§ enqueue Ù…Ø²Ø¯ÙˆØ¬Ø©ØŒ Ù„Ø§ 403.

Ø·Ø¨Ù‚Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø«Ø§Ø¨ØªØ© (z-index) Ø¨Ù„Ø§ Ø­Ø¬Ø¨.

Ø¥Ù† ÙˆØ§Ø¬Ù‡ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø£ÙŠ Ø§Ø®ØªÙ„Ø§Ù Ø£Ø³Ù…Ø§Ø¡ Ù…Ø³Ø§Ø±Ø§Øª/Ù…ÙƒÙˆÙ‘Ù†Ø§ØªØŒ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ø¯Ø£ Ù†ÙØ³Ù‡: Ù„Ø§ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±ØŒ ÙÙ‚Ø· Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø«ØŒ ØªØ¨Ø±ÙŠØ¯ØŒ ÙˆØ·Ø¨Ù‚Ø§Øª ÙˆØ§Ø¶Ø­Ø©.