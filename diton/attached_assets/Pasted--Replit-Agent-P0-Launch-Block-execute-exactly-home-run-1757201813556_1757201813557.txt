๐งญ Replit Agent โ P0 Launch Block (execute exactly)

ููุงุนุฏ ุตุงุฑูุฉ

ุงุนูู ููุท ูู ุฌุฐุฑ ุงููุดุฑูุน: /home/runner/workspace (Git root).

ุฃูุดุฆ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุฃู ุชุนุฏูู: _ops/backups/agent_p0_<UTCSTAMP>/โฆ.

ูุง ุชูุบููุฑ ุดูุฆูุง ุฎุงุฑุฌ ูุง ูู ูุทููุจ ูู ูุฐู ุงููููุฉ.

ุจุนุฏ ูู ุฌุฒุกุ ุงุทุจุน Acceptance Block ููุง ุจุงูุฃุณูู.

ุงููุฏู ุงูุนุงู (P0 ุงูููู)

ุนูุฑ +18 ูุงุจู ููุชุจุฏูู (AGE_PROVIDER=stub|veriff|yoti) ูุน:

POST /api/age/start (ูุนูุฏ session_id ุฃู redirect ุนูุฏ ุงููุฒูุฏ ุงูุญูููู).

POST /api/age/webhook (ูุซุจูุช ุงููุฑุงุฑ ููุถุจุท ุฌูุณุฉ ุงูุนูุฑ/ูููู).

/chat ูุฌุจ ุฃู ููุฌูู 307 ุฅุฐุง ูุง ุฌูุณุฉ ุนูุฑุ ุซู 200 ุจุนุฏ ุงูุงุนุชูุงุฏ.

Report/Block ุฎููู ุจูุง DB ุงูุขู:

POST /api/moderation/report (JSON: reason, peerId, tsโฆ) + rate-limit + CSRF ุจุณูุท.

ุงูุชุฎุฒูู ูุคูุชูุง: stdout + ููู ูุญูู ูู dev (_ops/reports/reports.ndjson). (ูู Vercel ูุงุญููุง: Blob/Email).

ุฒุฑ ุงููุงุฌูุฉ ููุทุน ุงูุงุชุตุงู ููุฑูุง ุจุนุฏ ุงูุฅุฑุณุงู.

Cooldown + hCaptcha ุนูู /api/match/next:

ูุงุฌูุฉ: throttle 700ms + guard ุดุจูู.

ุฎุงุฏู: sliding-window (ูุซุงู: >3 Next ุฎูุงู 2s โ 429) ูุน ุฏุนู hCaptcha token (ุชุญูู ุงุฎุชูุงุฑู ุฅู ุชูููุฑ ููุงุชูุญ).

Stripe VIP ูุตุฏุฑ ุงูุญูููุฉ:

Webhook ููููุน (checkout.session.completed, customer.subscription.updated|deleted).

Enforcement ูู ุงูุณูุฑูุฑ (ูุง ุงุนุชูุงุฏ ุนูู ุงููููู ูุญุฏู).

ููุทุฉ Reconcile ูุฏููุฉ ุจุณูุทุฉ (endpoint ุฏุงุฎูู ูุญูู).

ุฑุคูุณ ุงูุฃูุงู:

Permissions-Policy ุญุฑูููุง ุนูู /chat ุจุนุฏ ุงูุนูุฑ: camera=(self), microphone=(self).

CSP ููุงุณุจุฉ ูู self + wss:// (signal) + Stripe + TURN/STUN.

CSRF ูุทูุจุงุช POST ุงูุญุณูุงุณุฉ ููุท. CORS = same-origin.

Cookie Banner + DSAR:

Banner ูุนูู ูุจู ุฃู ุชุชุจุน.

ููุงุฉ ุฎุตูุตูุฉ: mailto:privacy@ditonachat.com ูุฑูุงุจุท ุตูุญุฉ ุทูุจ ุญุฐู.

ุชุฌููุฒ ุณุฑูุน

ูุง ุชูุถูู ุฃุณุฑุงุฑ ูููGit. ุงุณุชุฎุฏู ENV ููุท. ุฅู ูู ุชุชููุฑ ููุงุชูุญ (yoti/veriff/stripe/hcaptcha) ุงุณุชุฎุฏู stub ุขูู ูุง ููุนุทู ุงูุชุฏูู.

ุซุจูุช ุฃู /api/health ูู ุงููุฑุฌุน ุงููุญูุฏ ููุตุญุฉ (ูููุณ /_health).

๐๏ธ ููุงู ุชูููุฐูุฉ ููุตููุฉ

0) ูุณุฎุฉ ุงุญุชูุงุทูุฉ + ูุญุต ุฌุฐุฑ

ุงุตูุน ูููุฏุฑ backup: _ops/backups/agent_p0_<UTCSTAMP>/โฆ

ุงุญูุธ ูุณุฎูุง ูู ูุฐู ุงููููุงุช ุฅู ููุฌุฏุช:
package.json next.config.mjs middleware.ts src/app/api/** src/app/chat/** src/components/** src/lib/** src/utils/** src/hooks/**

ุงุทุจุน ุงูุฌุฐุฑ ุงูุญุงูู ููุชูุฌุฉ git rev-parse --show-toplevel.

1) ุนูุฑ +18 ูุงุจู ููุชุจุฏูู

ุฃุถู ูุชุบูุฑ AGE_PROVIDER (ูุฏุนู: stub ุงูุชุฑุงุถููุง).

ุฃูุดุฆ:

src/app/api/age/start/route.ts

src/app/api/age/webhook/route.ts

ุณููู stub:

POST /api/age/start โ { ok:true, session_id: "stub-"+ts }

POST /api/age/webhook โ ูุถุจุท Cookie ageok=1 ุณูุฉุ ููุฑุฏ { ok:true }

ุญุฏูุซ middleware.ts ุจุญูุซ:

ููุญูููู /chat ุฅูู 307 ุนูุฏ ุบูุงุจ ุงูุนูุฑ.

ุจุนุฏ ูุฌุงุญ webhookุ ุชุตุจุญ /chat 200.

ูุจูู (ุจุนุฏ ุงูุชูููุฐ):
ุดุบูู dev ูุญูููุงุ ูููุฐ:

ุฃูู ุฒูุงุฑุฉ /chat โ 307

POST /api/age/webhook โ 200

/chat โ 200
ุซู ุงุทุจุน Acceptance Block (HEALTH/AGE_FLOW/PP/CSS/VIP placeholders ุงูุขูุ ุณูููููุง ูุงุญููุง).

2) Report/Block

ุฃูุดุฆ src/app/api/moderation/report/route.ts:

ููุจู JSON (reason, peerId, ts, extra?).

rate-limit ุฎููู (ุงุณุชุฎุฏู ูุง ูุฏููุง ุฅู ููุฌุฏ lib/ratelimit).

CSRF ุจุณูุท (ุชููู ูู ุงูููุฏุฑ ูุน ุงุณุชุซูุงุก dev).

ูู dev: ุงูุชุจ ุณุทุฑ NDJSON ุฅูู _ops/reports/reports.ndjson + console.log.

ุงุฑุจุท ุฒุฑ ุงููุงุฌูุฉ โReport/Shieldโ ูู:

ูุฑุณู POST ูููุทุน ุงูุงุชุตุงู (event bus).

ููุธูุฑ Toast ุจุงููุฌุงุญ/ุงููุดู.

ูุจูู: ุงุณุชุฏุนู endpoint ุจุนูููุฉ JSONุ ูุชุญูู ูู ุณุทุฑ NDJSON.

3) Cooldown + hCaptcha ุนูู /api/match/next

ูุงุฌูุฉ: ุชุฃูุฏ ูู throttle ~700ms + ููุน reentry ุฃุซูุงุก ุงูุชุธุงุฑ ุงูุดุจูุฉ.

ุฎุงุฏู: sliding-window guard:

3 ุทูุจุงุช ุฎูุงู 2 ุซุงููุฉ โ 429 JSON { rate_limited:true }

ุฏุนู hcaptcha_token (ุฅู ุชูููุฑ ENVุ ุชุญูู ูุฅูุง ุชุฌุงูุฒู ูู stub).

ูุจูู: ูููุฐ 5 ุทูุจุงุช ุณุฑูุนุฉ ูู/api/match/next ูุชุญูู ูู ุชููู 429 ุนูู ุงูุฃูู ูุงุญุฏูุง.

4) Stripe VIP

ุฃุถู/ุฃููู Webhook:

ุฑููุฒ ุนูู events: checkout.session.completed, customer.subscription.updated|deleted.

ุญุฏุซ ูุฌุงุญ โ vip=true (cookie/session ุนูู ุงููุฏู ุงููุฑูุจ) + ุฃุณุงุณ enforcement ูู ุงูุณูุฑูุฑ.

ุญุฏูุซ /api/user/vip-status ูููุฑุฃ ุงูุญุงูุฉ ูู cookie ุงูุขูุ ูุน ููุถุน ูุงุถุญ ูุฅุถุงูุฉ ูุฑุงุกุฉ ูู store/DB ูุงุญููุง.

ุฃุถู endpoint ุฏุงุฎูู (ูุญูู IP/secret) ูู Reconcile ุจุณูุท.

ูุจูู: ูู devุ ุญุงูู ุญุฏุซ webhook ุจูููุฐุฌ JSON ูุญููุ ูุชุญูู ูู ุชุบููุฑ ุงูุญุงูุฉ.

5) ุฑุคูุณ ุงูุฃูุงู

ุซุจูุช ููุงุฆููุง ูู next.config.mjs:

Permissions-Policy: camera=(self), microphone=(self) (ุทุจููู ุนูู /chat).

CSP ููููุฏุฉ ุจุดูู ุขูู (self + wss:// ูููsignal + Stripe + TURN/STUN).

ูุจูู:

ูุนูู ุงูุนูุฑุ ุงุทูุจ HEAD /chat: ูุฌุจ ุฃู ุชุฑู ุงูููุฏุฑ ุญุฑูููุง.

ุชุฃูุฏ ุฃู CSS ูุนูู (ุฑุงุจุท / _next/static/css/*.css + Utilities ููุฌูุฏุฉ).

6) Cookie Banner + DSAR

ุฃุถู Banner ูุนูู (ูููุน ุฃู ุชุชุจุน ูุจู ุงูููุงููุฉ).

ุฃุถู ุตูุญุฉ/ุฑุงุจุท privacy@ditonachat.com.

ูุจูู: ุงููููุญุฉ ุชุธูุฑ ุฃูู ุฒูุงุฑุฉุ ุนูุฏ ุงูุฑูุถ ูุง ุชุญููู ุชุชุจุน.

โ ูุญูุต ููุงุฆูุฉ (ุงุทุจุน ูุฐุง ุจุงูุถุจุท)

ุจุนุฏ ุชุดุบูู dev ูุญูููุง ุนูู :3000 ูููุฐ:

-- Acceptance --
HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/api/health)
AGE_FLOW=$( (code1=$(curl -s -D - -o /dev/null http://127.0.0.1:3000/chat | awk 'NR==1{print $2}'); curl -s -X POST http://127.0.0.1:3000/api/age/webhook >/dev/null; code2=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/chat); [ "$code1" = "307" ] && [ "$code2" = "200" ] && echo ok || echo fail ))
PERMISSIONS_POLICY=$(curl -s -I http://127.0.0.1:3000/chat | awk 'BEGIN{IGNORECASE=1}/^Permissions-Policy:/{sub(/\r$/,"");print substr($0,index($0,":")+2)}')
CSS_LINK=$([ -n "$(curl -s http://127.0.0.1:3000/ | grep -oE "/_next/static/css/[^\"']+\.css" | head -1)" ] && echo 1 || echo 0)
VIP_PRE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/api/user/vip-status)
VIP_POST=$(curl -s -o /dev/null -w "%{http_code}" -H "Cookie: vip=1" http://127.0.0.1:3000/api/user/vip-status)
REPORT=$([ -s _ops/reports/reports.ndjson ] && echo ok || echo missing)
COOLDOWN=$( (n429=0; for i in 1 2 3 4 5; do c=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/api/match/next); [ "$c" = "429" ] && n429=$((n429+1)); done; [ $n429 -ge 1 ] && echo ok || echo weak) )
echo "HEALTH=$HEALTH"
echo "AGE_FLOW=$AGE_FLOW"
echo "PERMISSIONS_POLICY=$PERMISSIONS_POLICY"
echo "CSS_LINK=$CSS_LINK utilities:found"
echo "VIP=pre:$VIP_PRE post:$VIP_POST"
echo "REPORT=$REPORT  COOLDOWN=$COOLDOWN"
echo "-- End Acceptance --"


ุชุณูููู ุงููุทููุจ:

ุงูุชุบููุฑุงุช ุงูุจุฑูุฌูุฉ (P0) ููุชููุฉ.

ููุทุงุช ูู ุงููAcceptance Block.

ููุฎุต ุงููููุงุช ุงููุนุฏููุฉ + ูููุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.

ุญูุงุฌุฒ ุงูุชูููุฉ/ุงูุฃุฏุงุก

ูุง ุชุซุจูุช ุญุฒู ุฌุฏูุฏุฉ ุฅูุง ููุถุฑูุฑุฉ.

ุฃุนุฏ ุงุณุชุฎุฏุงู dev server ูุฏุฑ ุงูุฅููุงูุ ูุชุฌููุจ build ูุชูุฑุฑ.

ูุง ุชุชุตู ุจุฎุฏูุงุช ุฎุงุฑุฌูุฉุ ุงุณุชุฎุฏู stub ุญุชู ุชุฒูููุฏ ุงูููุงุชูุญ.