#!/usr/bin/env bash
set -euo pipefail

# Goal: Ø¥ØµÙ„Ø§Ø­ ØªÙˆØµÙŠÙ„ FilterBar Ù„ÙØªØ­ Ø§Ù„Ù€modals Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† window eventsØŒ
# ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø²Ø±Ø§Ø± âš§ ÙˆğŸŒ Ø¨Ø£Ù‚ØµÙ‰ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙŠØ§ Ø§Ù„ÙŠÙ…Ù†Ù‰ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ.
# Minimal-Diff. Ù„Ø§ Ù…Ø³Ø§Ø³ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ù„Ø§ Ø­Ø°Ù Ù…ÙŠØ²Ø§Øª.

LABEL="fix_filterbar_wiring_$(date -u +%Y%m%d-%H%M%S)"
BACKUP_DIR="_ops/backups/$LABEL"
BRANCH="fix/ui-filterbar-wiring"
mkdir -p "$BACKUP_DIR"

echo "[1/8] Ø¥Ù†Ø´Ø§Ø¡ ÙØ±Ø¹ Ø¹Ù…Ù„ Ø¢Ù…Ù†"
git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"

echo "[2/8] Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
for f in \
  "src/app/chat/components/FilterBar.tsx" \
  "src/app/chat/ChatClient.tsx"
do
  [ -f "$f" ] && install -D "$f" "$BACKUP_DIR/$f"
done

echo "[3/8] ÙƒØªØ§Ø¨Ø© FilterBar.tsx ÙƒØ¹Ù…ÙŠÙ„ Ù…Ø¹ state Ù…Ø­Ù„ÙŠ + Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø£Ù‚ØµÙ‰ Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ†"
cat > src/app/chat/components/FilterBar.tsx <<'TSX'
"use client";

import dynamic from "next/dynamic";
import { useState } from "react";

const GenderModal = dynamic(() => import("./GenderModal"), { ssr: false });
const CountryModal = dynamic(() => import("./CountryModal"), { ssr: false });

export default function FilterBar() {
  const [openGender, setOpenGender] = useState(false);
  const [openCountry, setOpenCountry] = useState(false);

  return (
    <div className="absolute top-1 right-1 z-[60] flex items-center gap-2 pointer-events-none">
      {/* Gender */}
      <button
        type="button"
        data-ui="gender-button"
        aria-label="Gender"
        onClick={() => setOpenGender(true)}
        className="pointer-events-auto h-8 w-8 grid place-items-center rounded-xl bg-black/30 hover:bg-black/40 text-white text-sm backdrop-blur transition"
      >
        <span
          aria-hidden
          className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-rose-400"
          style={{ lineHeight: 1 }}
        >
          âš§
        </span>
      </button>

      {/* Countries */}
      <button
        type="button"
        data-ui="country-button"
        aria-label="Countries"
        onClick={() => setOpenCountry(true)}
        className="pointer-events-auto h-8 w-8 grid place-items-center rounded-xl bg-black/30 hover:bg-black/40 text-white text-sm backdrop-blur transition"
      >
        <span aria-hidden style={{ lineHeight: 1 }}>ğŸŒ</span>
      </button>

      {/* badges placeholders */}
      <div data-ui="gender-badge" className="sr-only"></div>
      <div data-ui="country-count-badge" className="sr-only"></div>

      {/* Modals */}
      {openGender && (
        <GenderModal open={true} onClose={() => setOpenGender(false)} />
      )}
      {openCountry && (
        <CountryModal open={true} onClose={() => setOpenCountry(false)} />
      )}
    </div>
  );
}
TSX

echo "[4/8] ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø±Ø¯Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† ChatClient.tsx"
# Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙˆØ§Ø±Ø¯Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
sed -i -E '/RemoteTopRight|CountrySelect|GenderSelect/d' src/app/chat/ChatClient.tsx || true

echo "[5/8] Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ FilterBar Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­"
if ! grep -q 'components/FilterBar' src/app/chat/ChatClient.tsx; then
  if grep -n -m1 -E '^[\"\x27]use client[\"\x27]' src/app/chat/ChatClient.tsx >/dev/null; then
    ln=$(grep -n -m1 -E '^[\"\x27]use client[\"\x27]' src/app/chat/ChatClient.tsx | cut -d: -f1)
    awk -v ln="$ln" 'NR==ln{print; print "import FilterBar from \"@/app/chat/components/FilterBar\";"; next} {print}' \
      src/app/chat/ChatClient.tsx > src/app/chat/ChatClient.tsx.tmp && mv src/app/chat/ChatClient.tsx.tmp src/app/chat/ChatClient.tsx
  else
    sed -i '1i import FilterBar from "@\/app\/chat\/components\/FilterBar";' src/app/chat/ChatClient.tsx
  fi
fi

echo "[6/8] Ø¥Ø¯Ø±Ø§Ø¬ <FilterBar /> Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·"
if ! grep -q '<FilterBar />' src/app/chat/ChatClient.tsx; then
  # Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ <section ...> ÙÙŠ Ø§Ù„Ù…Ù„Ù (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ø¯ÙŠÙ‡ className="relative h-1/2 ..." Ø¹Ø§Ø¯Ø©)
  awk '
    BEGIN{ins=0}
    ins==0 && $0 ~ /<section/ { print; print "        <FilterBar />"; ins=1; next }
    { print }
  ' src/app/chat/ChatClient.tsx > src/app/chat/ChatClient.tsx.tmp && mv src/app/chat/ChatClient.tsx.tmp src/app/chat/ChatClient.tsx
fi

echo "[7/8] Ø¨Ù†Ø§Ø¡ ÙˆÙØ­Øµ REST-RTC (Ù‚Ø±Ø§Ø¦ÙŠ ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©)"
set +e
pnpm build >/tmp/build.log 2>&1
BUILD_RC=$?
bash _ops/acc_rtc.sh https://www.ditonachat.com >/tmp/acc.log 2>&1
ACC_RC=$?
set -e

echo "[8/8] Ø¥Ø¶Ø§ÙØ©ØŒ ÙƒÙˆÙ…ÙØªØŒ Ø¯ÙØ¹ Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ main)"
git add -A
git commit -m "fix(ui): wire FilterBar with local state; place âš§/ğŸŒ at top-right; keep server untouched" || true
git push -u origin "$BRANCH"

echo
echo "-- Acceptance --"
echo "BACKUP_DIR=$BACKUP_DIR"
echo "HAS_FilterBarButtons=$(grep -c 'data-ui=\"gender-button\"' src/app/chat/components/FilterBar.tsx || true)"
echo "CHATCLIENT_IMPORT=$(grep -c 'components/FilterBar' src/app/chat/ChatClient.tsx || true)"
echo "CHATCLIENT_USAGE=$(grep -c '<FilterBar />' src/app/chat/ChatClient.tsx || true)"
echo "BUILD_RC=$BUILD_RC  (Ø±Ø§Ø¬Ø¹ /tmp/build.log Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)"
echo "ACC_RC=$ACC_RC     (Ø±Ø§Ø¬Ø¹ /tmp/acc.log Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)"
echo "NEXT_STEP=Ø§ÙØªØ­ /chat ÙˆØ§Ø¶ØºØ· âš§ Ø«Ù… ğŸŒ â€” ÙŠØ¬Ø¨ Ø£Ù† ØªÙØªØ­ Ø§Ù„Ù€modals Ø¨Ù„Ø§ Ø£Ø®Ø·Ø§Ø¡ Console."
