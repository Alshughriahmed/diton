# ---------- PHASE 2: Toolbar wiring + filters dropdowns + gestures + layout tweaks ----------
set -e

mkdir -p src/lib src/lib/ui src/lib/match

# 1) Toast Ø®ÙÙŠÙ
cat > src/lib/ui/toast.ts <<'TS'
export function toast(msg:string, ms=2500){
  const el=document.createElement('div');
  el.textContent=msg;
  el.style.cssText='position:fixed;left:12px;bottom:12px;z-index:9999;background:#111a;border:1px solid #333;padding:8px 12px;border-radius:10px;color:#fff;font:500 13px system-ui;backdrop-filter:blur(6px)';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),ms);
}
TS

# 2) Ø£Ø¯ÙˆØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¨Ø³Ø·Ø© (Next/Prev Ù…Ø¹ fallback Ø¨Ø¹Ø¯ 7 Ø«ÙˆØ§Ù†Ù)
cat > src/lib/match/controls.ts <<'TS'
import { toast } from '@/lib/ui/toast';

export async function nextMatch(payload:any={}){
  try{
    await fetch('/api/match/next',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
    toast('â­ï¸ Nextâ€¦');
  }catch{ toast('ØªØ¹Ø°Ù‘Ø± Ø·Ù„Ø¨ Next'); }
}

export async function tryPrevOrRandom(payload:any={}){
  // Ù†ÙØ·Ù„Ù‚ Ø­Ø¯Ø« Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù…Ù† Ù„Ø¯ÙŠÙ‡ Ù…Ù†Ø·Ù‚ prevØŒ ÙˆØ¥Ù† Ù„Ù… ÙŠØªÙ… Ø®Ù„Ø§Ù„ 7s Ù†Ø¹Ù…Ù„ Next
  const evt = new CustomEvent('ditona:prev-wanted');
  window.dispatchEvent(evt);
  toast('â®ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø¢Ø®Ø± Ù…ØªØµÙ„â€¦');
  let resolved=false;
  const ok=()=>{resolved=true; toast('ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø¢Ø®Ø± Ù…ØªØµÙ„');};
  window.addEventListener('ditona:prev-ok', ok, {once:true});
  await new Promise(r=>setTimeout(r,7000));
  window.removeEventListener('ditona:prev-ok', ok as any);
  if(!resolved){
    toast('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ØªØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ â€” Ø¬Ø§Ø±ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ø·ÙŠÙØ©');
    await nextMatch(payload);
  }
}
TS

# 3) Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¨Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©
applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/components/chat/ChatToolbar.tsx
@@
-  <button 
-    onClick={() => emit("ui:openSettings")}
+  <button 
+    onClick={() => emit("ui:next")}
     className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700 transition-colors" 
-    aria-label="Settings"
+    aria-label="Next"
   >
-    âš™ï¸
+    Next â–¶
   </button>
*** End Patch
PATCH

applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/components/chat/ChatToolbar.tsx
@@
   {/* Ù…Ø«Ø§Ù„ Ù„Ù„Ø£Ø²Ø±Ø§Ø±â€¦ Ù†Ø¶ÙŠÙ Ø³Ù…Ø§Ø¹Ø©/Ù…Ø§ÙŠÙƒ/Ø¥Ø¹Ø¬Ø§Ø¨/Ù…Ø§Ø³Ùƒ/Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª/Ø¥ÙŠÙ‚Ø§Ù/Ø¥Ø¨Ù„Ø§Øº/Ø³Ø§Ø¨Ù‚ */}
-  {/* Ø§Ù„Ø²Ø±Ù‘Ø§Ù† Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø§Ù† Ø³Ø§Ø¨Ù‚Ù‹Ø§ Ù…Ø­ÙÙˆØ¸Ø§Ù† */}
+  <button onClick={()=>emit('ui:toggleRemoteAudio')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Mute remote">ğŸ”ˆ</button>
+  <button onClick={()=>emit('ui:toggleMic')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Mic">ğŸ™ï¸</button>
+  <button onClick={()=>emit('ui:toggleMasks')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Masks">ğŸ¤¡</button>
+  <button onClick={()=>emit('ui:openSettings')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Settings">âš™ï¸</button>
+  <button onClick={()=>emit('ui:togglePlay')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Stop/Play">â¯ï¸</button>
+  <button onClick={()=>emit('ui:report')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Report">ğŸš©</button>
+  <button onClick={()=>emit('ui:prev')} className="px-3 py-2 rounded-lg bg-neutral-800 text-white text-sm border border-neutral-700 hover:bg-neutral-700" aria-label="Prev">â®ï¸ Prev</button>
*** End Patch
PATCH

# 4) Ù…Ø³ØªÙ…Ø¹Ùˆ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ ChatClient (ØªÙØ¹ÙŠÙ„ ÙØ¹Ù„ÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± + Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø­Ø¨)
applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/app/chat/ChatClient.tsx
@@
 import { on, emit } from '@/lib/bus';
+import { toast } from '@/lib/ui/toast';
+import { nextMatch, tryPrevOrRandom } from '@/lib/match/controls';
+import { useProfile } from '@/state/profile';
@@
-  let off4=on("ui:openSettings",()=>{ try{ window.location.href='/settings'; }catch{} });
+  let off4=on("ui:openSettings",()=>{ try{ window.location.href='/settings'; }catch{} });
+  let offN=on("ui:next", ()=>{ nextMatch({filters}); });
+  let offP=on("ui:prev", ()=>{ tryPrevOrRandom({filters}); });
+  let offR=on("ui:report", async ()=>{ 
+    try{ await fetch('/api/moderation/report',{method:'POST'}); toast('ğŸš© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„'); }catch{}
+    nextMatch({filters});
+  });
+  let offPlay=on("ui:togglePlay", ()=>{
+    setState(s=>({ ...s, paused: !s.paused }));
+    toast('ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
+  });
+  let offMuteRemote=on("ui:toggleRemoteAudio", ()=>{
+    const v=document.querySelector('video[data-role="remote"],#remoteVideo') as HTMLVideoElement|null;
+    if(v){ v.muted = !v.muted; toast(v.muted?'ğŸ”‡ ØµÙ…Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ':'ğŸ”ˆ Ø³Ù…Ø§Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ'); }
+  });
+  let offMic=on("ui:toggleMic", ()=>{
+    try{
+      const v=document.querySelector('video[data-role="local"],#localVideo') as HTMLVideoElement|null;
+      const s=v?.srcObject as MediaStream|undefined;
+      if(s){ const on=!s.getAudioTracks()[0]?.enabled; s.getAudioTracks().forEach(t=>t.enabled=on); toast(on?'ğŸ™ï¸ Ø§Ù„Ù…ÙŠÙƒ Ù…ÙØ¹Ù‘Ù„':'ğŸ”• Ø§Ù„Ù…ÙŠÙƒ Ù…ÙƒØªÙˆÙ…'); }
+    }catch{}
+  });
@@
   useEffect(()=>{
+    // Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø­Ø¨: ÙŠÙ…ÙŠÙ†â†’ÙŠØ³Ø§Ø± = NextØŒ ÙŠØ³Ø§Ø±â†’ÙŠÙ…ÙŠÙ† = Prev
+    let x0=0, y0=0, moved=false;
+    const down=(e:PointerEvent)=>{ x0=e.clientX; y0=e.clientY; moved=false; };
+    const up=(e:PointerEvent)=>{
+      const dx=e.clientX-x0, dy=e.clientY-y0;
+      if(Math.abs(dx) > 60 && Math.abs(dy) < 60){
+        if(dx<0) emit('ui:next'); else emit('ui:prev');
+      }
+    };
+    window.addEventListener('pointerdown',down);
+    window.addEventListener('pointerup',up);
     return ()=>{
+      window.removeEventListener('pointerdown',down);
+      window.removeEventListener('pointerup',up);
+      offN(); offP(); offR(); offPlay(); offMuteRemote(); offMic();
     };
   },[]);
*** End Patch
PATCH

# 5) ØªÙØ¹ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ø¬Ù†Ø³ (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ + Ù‚ÙÙ„ Ù„ØºÙŠØ± VIP Ø¥Ù† Ù„Ø²Ù…)
applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/components/CountryFilter.tsx
@@
 'use client';
-import React from 'react';
+import React, { useState } from 'react';
 import { emit } from '@/lib/bus';
+import { toast } from '@/lib/ui/toast';
+import { useVip } from '@/hooks/useVip' /* Ø¥Ù† ÙˆÙØ¬Ø¯Øª */;

 export default function CountryFilter(){
-  return (<button className="...">Countries (0)</button>);
+  const [open,setOpen]=useState(false);
+  const { isVip, FREE_FOR_ALL } = (globalThis as any).__vip ?? {isVip:false, FREE_FOR_ALL:true};
+  const lock = !isVip && !FREE_FOR_ALL;
+  return (
+    <div className="relative">
+      <button onClick={()=>{ if(lock){ toast('ğŸ”’ Ù…ÙŠØ²Ø© Ø®Ø§ØµØ© Ø¨Ù€ VIP'); emit('ui:upsell','countries'); } else setOpen(v=>!v); }}
+        className="px-3 py-1.5 rounded-xl bg-neutral-900/70 border border-neutral-700 text-white text-sm">
+        ğŸŒ Countries (0)
+      </button>
+      {open && (
+        <div className="absolute right-0 mt-2 w-[320px] max-h-[320px] overflow-auto bg-neutral-900/95 border border-neutral-700 rounded-xl p-2 grid grid-cols-2 gap-1">
+          {/* TODO: Ø­Ù…Ù‘Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„ Ù…Ù† JSON Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…Ø¶Ø§ÙØ© */}
+          <button className="px-2 py-1 rounded hover:bg-neutral-800 text-left">All</button>
+        </div>
+      )}
+    </div>
+  );
 }
*** End Patch
PATCH

applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/components/GenderFilter.tsx
@@
 'use client';
-import React from 'react';
+import React, { useState } from 'react';
 import { emit } from '@/lib/bus';
+import { toast } from '@/lib/ui/toast';

 export default function GenderFilter(){
-  return (<button className="...">Gender: All</button>);
+  const [open,setOpen]=useState(false);
+  const lock = !(globalThis as any).__vip?.isVip && !(globalThis as any).__vip?.FREE_FOR_ALL;
+  const Opt=(v:string, lbl:string)=>(
+    <button onClick={()=>{ emit('filters:gender', v); setOpen(false); }} className="px-2 py-1 rounded hover:bg-neutral-800 text-left">{lbl}</button>
+  );
+  return (
+    <div className="relative">
+      <button onClick={()=>{ if(lock){ toast('ğŸ”’ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ù†Ø³ Ø­ØµØ±ÙŠØ© VIP'); emit('ui:upsell','gender'); } else setOpen(v=>!v); }}
+        className="px-3 py-1.5 rounded-xl bg-neutral-900/70 border border-neutral-700 text-white text-sm">
+        âš¥ Gender
+      </button>
+      {open && (
+        <div className="absolute right-0 mt-2 w-[220px] bg-neutral-900/95 border border-neutral-700 rounded-xl p-2 grid gap-1">
+          {Opt('all','All')} {Opt('male','â™‚ Male')} {Opt('female','â™€ Female')} {Opt('couple','ğŸ‘« Couple')} {Opt('lgbt','ğŸŒˆ LGBT')}
+        </div>
+      )}
+    </div>
+  );
 }
*** End Patch
PATCH

# 6) Ù†Ù‚Ù„ Ø¹Ø¯Ù‘Ø§Ø¯ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ²Ø±ÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„ØªØ¬Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ (Ø­Ø§ÙˆÙŠØ© QuickActions Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
applypatch << 'PATCH'
*** Begin Patch
*** Update File: src/components/QuickActions.tsx
@@
-<div className="absolute bottom-3 right-3 ...">
+<div className="absolute top-3 right-3 ...">
*** End Patch
PATCH || true

# 7) Ø¨Ù†Ø§Ø¡
pnpm build
echo "PHASE 2 ready. Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Next/Prev/Audio/Mic/Stop/Report) ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… (Gender/Countries) ÙˆØ§Ù„Ø³Ø­Ø¨ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±."
