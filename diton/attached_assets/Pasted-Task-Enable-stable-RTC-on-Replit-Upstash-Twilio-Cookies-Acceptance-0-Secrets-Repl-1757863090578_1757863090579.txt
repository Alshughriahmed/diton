Task: Enable stable RTC on Replit (Upstash + Twilio + Cookies) + Acceptance
0) Secrets (أضِف كـ Replit Secrets)

UPSTASH_REDIS_REST_URL=…

UPSTASH_REDIS_REST_TOKEN=…

(إحدى الطريقتين للـ TURN)

ديناميكي Twilio:
TWILIO_ACCOUNT_SID=…
TWILIO_AUTH_TOKEN=…

أو ثابت:
TURN_URLS=turn:global.turn.twilio.com:3478?transport=udp,turn:global.turn.twilio.com:3478?transport=tcp,turns:global.turn.twilio.com:443?transport=tcp
TWILIO_TURN_USERNAME=…
TWILIO_TURN_CREDENTIAL=…

NEXTAUTH_URL=https://<your-repl>.replit.dev

NEXTAUTH_SECRET= قيمة طويلة عشوائية

1) Code changes (Minimal-Diff)

a) /src/app/api/turn/route.ts (اختر أحد الخيارين)

خيار Twilio ديناميكي (مفضل): استبدل المحتوى بالكامل بكود جلب Token من Twilio (يرجّع iceServers مع turns:...:443 و username/credential).

أو خيار ثابت: رجّع iceServers من TURN_URLS, TWILIO_TURN_USERNAME, TWILIO_TURN_CREDENTIAL إن وُجدت، وإلا STUN فقط.

b) /src/app/api/anon/init/route.ts
أزِل domain الثابت من الكوكي (يبقى Secure/Lax):

- domain: ".ditonachat.com"

2) Build & smoke

Run: pnpm build

Start dev: pnpm dev

3) Acceptance (شغّل سكربت واحد داخل Shell)

أنشئ ملف _ops/accept_repl.sh ثم نفّذ:

bash _ops/accept_repl.sh https://<your-repl>.replit.dev


محتوى مختصر للسكربت (ليطبعه في النهاية بلوك القبول):

GET /api/rtc/env ⇒ تحقق mode=redis و ping_ok=true.

GET /api/turn ⇒ تحقق وجود turns:...:443 ووجود credential.

تهيئة anon لطرفين (cookiesA/B) عبر /api/anon/init.

POST /api/rtc/enqueue للطرفين (204).

POST /api/rtc/matchmake للطرفين ⇒ نفس pairId، أدوار caller/callee.

تبادل OFFER/ANSWER و ICE بالترتيب الصحيح بدون أي 403.

اطبع:

-- Acceptance --
RTC_MODE=redis
RTC_PING_OK=1
TURN_TLS443_PRESENT=1
TURN_CREDENTIAL_PRESENT=1
PAIR_ID_MATCH=1
NO_403_ON_RTC=1
-- End Acceptance --

4) Commit

رسالة: chore(rtc): enable Upstash+Twilio on Replit, cookie domain fix, acceptance script

5) Rollback (لو لزم)

أعِد /api/turn للـ STUN فقط، وأعد domain حسب الإنتاج.

المخرجات المتوقعة بعد التنفيذ:

/api/rtc/env: mode=redis, ping_ok=1

/api/turn: يتضمن turns:...:443 + credential

القبول يطبع بلوك النجاح أعلاه.

إذا موافق، انسخ النص كدفعة واحدة للوكيل؛ بعدها أتحقق معك من بلوك القبول ونقفل ملف الـRTC.