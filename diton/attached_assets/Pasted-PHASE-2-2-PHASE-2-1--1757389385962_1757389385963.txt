PHASE 2.2 — ربط الوظائف الحقيقية وصقل الواجهة

الهدف العام: تحويل كل ما ظهر بصريًا في PHASE 2.1 إلى وظائف كاملة ومتينة، وربط البيانات الحيّة، وإزالة أخطاء الكونسول، مع الحفاظ على أقفال الـVIP ونافذة Upsell.

1) مرشّحات الدول/الجنس (فعليًا)

تفعيل القوائم المنسدلة بالكامل (Portal + z-index مرتفع) والتأكد من عدم التداخل مع باقي الطبقات.

عند تغيير أي مرشح:

حفظ التفضيل في profile store ثم إرسالها مع طلب المطابقة /api/match/next.

تحديث الشرائح (chips) الخاصة بالطرف الثاني ديناميكيًا مع كل مطابقة.

غير VIP: يظهر القفل ويُفتح Upsell عند النقر؛ VIP: حد 2 للجنس و15 دولة مع رسائل Toast عند تجاوز الحد.

2) تجميل الوجه “حقيقي”

تفعيل Skin Smoothing حقيقي (MediaPipe/FaceMesh أو قناع Blur موجه للمناطق الجلدية).

مستويات: Low/Med/High (افتراضي Med). إظهار شارة “Beauty ON”.

هدف الأداء ≥24fps مع تعطيل تلقائي لو انخفض الأداء <18fps.

3) شريط الأدوات — ربط كامل

Next: يطلب مطابقة جديدة فورًا مع مؤشر حالة.

Prev: يحاول استعادة آخر شريك حتى 7 ثوانٍ؛ عند الفشل Toast: “لم نعثر على المتصل السابق — انتقلنا لمطابقة جديدة”.

Mute remote / Mic local: تبديل فعلي لمسارات الصوت (WebRTC tracks) مع حالات بصرية واضحة.

Masks: تفعيل/تعطيل الشريط؛ غير VIP → Upsell.

Settings: يفتح /settings.

Stop/Play: يوقف/يستأنف المطابقة فعليًا (لا طلبات شبكية أثناء الإيقاف).

Report: يستدعي /api/moderation/report ثم ينتقل تلقائيًا إلى Next مع Toast تأكيد لطيف.

4) معلومات الطرف الثاني (حية)

البطاقة أعلى يسار العلوي تعرض: أفاتاره/اسمه/شارة VIP/عدّاد إعجاباته + نقطة اتصال.

الشرائح أسفل يسار العلوي: بلد/مدينة/جنس/عمر الطرف الثاني بناءً على الداتا القادمة من السيرفر في حدث المطابقة.

عند غياب الحقول تُعرض قيم افتراضية أنيقة (Anonymous, —).

5) نظام الإعجابات

ربط زر ❤ بـ /api/user/like (toggle) وتحديث عدّادي: عدّاداتي (أنا) أعلى يمين السفلي، وعدّاد الطرف الثاني في بطاقته.

إن حدث إعجاب متبادل → Toast “It’s a match!” خفيف.

عند العودة لنفس المستخدم لاحقًا: يعكس الزر الحالة السابقة مباشرة.

6) الرسائل النصية (واجهة كاملة)

إظهار مؤلف الرسائل أسفل السفلي: زر إرسال يمين، Emoji يسار (إدراج داخل النص).

عرض آخر 3 رسائل دائمًا فوق المؤلف يسار؛ سحب لأعلى لعرض الأقدم؛ ضغطة مطوّلة لنسخ النص.

ضيف: حد 15 رسالة/جلسة (عميل + خادم). تفريغ الرسائل عند قطع المطابقة.

7) تدفّق Upsell + الدفع

النقر على ميزة مقفلة يفتح Upsell بمحتوى ميزة محددة + CTA:

إن لم يسجّل الدخول → /login?returnTo=/plans?sku=vip-month

مسجّل → /plans ثم Stripe Checkout.

بعد Webhook وترقية VIP: تحديث الـgates مباشرة دون إعادة تحميل (poll أو revalidate).

8) صقل الاستجابة والتموضع

تثبيت لوحة أدواتي أعلى يمين السفلي دون أن تغطي الفيديو، مع Auto-hide بعد 3 ثوانٍ من عدم التفاعل (الظهور عند اللمس).

زر Next أكبر من بقية الأزرار؛ عدم تداخله مع أي Overlay على الشاشات الصغيرة.

الإيماءات: سحب يمين→يسار = Next، يسار→يمين = Prev (حساسية 60px) + Toast تفسيري عند التفعيل.

9) تنظيف الأخطاء والإعدادات الإنتاجية

إصلاح أخطاء الكونسول الظاهرة بالصور:

/api/auth/* 500 و “Unexpected end of JSON input” → تأكيد NEXTAUTH_URL (بيئة Vercel + Replit preview) ومعالجة raw body للـApp Router.

favicon.ico 404 → إضافة أيقونة صحيحة في root.

التحقق من تزامن بيئات OAuth (Client ID/Secret/Redirects) في Vercel Preview/Prod.

إبقاء FREE_FOR_ALL فعّال في dev فقط.

معايير القبول (Checklist)

القوائم المنسدلة للجنس/الدول تعمل فعليًا وتؤثر على المطابقة؛ تظهر فوق كل الطبقات.

أقفال VIP: تظهر للمجاني؛ النقر يفتح Upsell ولا يغيّر الحالة.

التجميل يظهر فرقًا ملحوظًا وبأداء ≥24fps.

جميع أزرار الشريط تعمل كما هو موصوف، مع حالات بصرية واضحة.

معلومات الطرف الثاني (أعلى/أسفل يسار) تتبدّل مع كل مطابقة.

زر ❤ يحدّث العدّادات وحالة الإعجاب السابقة تُستعاد عند إعادة المطابقة.

واجهة الرسائل: آخر 3 دائمًا، سحب للأقدم، نسخ بالضغط المطوّل؛ حدّ الضيف 15 enforced.

الإيماءات تعمل، وPrev يُظهر Toast عند الفشل ثم ينتقل لـNext.

لا أخطاء حمراء بالكونسول (Auth/Favicon).

مخرجات الدفعة: كود مُدمج، ملاحظات الاختبار، صور/ڤيديو قصير يوضح الحالات، وتمرير الـChecklist أعلاه.