ØªØ¹Ù…Ù„ Ù…Ù† Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹. Ø§Ù„Ø¯ÙØ¹Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…ØªÙƒØ±Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (idempotent).

#!/usr/bin/env bash
set -euo pipefail

echo "=== 0) ÙØ±Ø¹ Ø¢Ù…Ù† ==="
git checkout -b fix/upstash-pipeline || git checkout fix/upstash-pipeline || true
mkdir -p _ops/backup || true
cp -f src/lib/rtc/upstash.ts _ops/backup/upstash.ts.bak 2>/dev/null || true
cp -f _ops/acc_rtc.sh _ops/backup/acc_rtc.sh.bak 2>/dev/null || true

echo "=== 1) Patch: ØªØµØ­ÙŠØ­ Ø´ÙƒÙ„ /pipeline (JSON array ÙˆÙ„ÙŠØ³ {commands}) ==="
applypatch() {
cat > /tmp/patch_upstash_pipeline.diff <<'PATCH'
*** Begin Patch
*** Update File: src/lib/rtc/upstash.ts
@@
-async function pipe(commands: Cmd[]) {
-  if (MODE === "memory") throw new Error("MEMORY_MODE");
-  const r = await fetch(`${URL}/pipeline`, {
-    method: "POST",
-    headers: { "content-type": "application/json", authorization: `Bearer ${TOKEN}` },
-    body: JSON.stringify({ commands }),
-    cache: "no-store",
-  });
+async function pipe(commands: Cmd[]) {
+  if (MODE === "memory") throw new Error("MEMORY_MODE");
+  // Upstash REST /pipeline ÙŠØªÙˆÙ‚Ø¹ Ù…ØµÙÙˆÙØ© Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ù„Ø§ ÙƒØ§Ø¦Ù† {commands:[]}
+  const r = await fetch(`${URL}/pipeline`, {
+    method: "POST",
+    headers: { "content-type": "application/json", authorization: `Bearer ${TOKEN}` },
+    body: JSON.stringify(commands),
+    cache: "no-store",
+  });
*** End Patch
PATCH
git apply --index --reject --whitespace=fix /tmp/patch_upstash_pipeline.diff
}
applypatch || { echo "Patch failed; Ø³Ø£Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹."; }

# (Ù„Ùˆ ÙØ´Ù„ patch Ø¨Ø³Ø¨Ø¨ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨Ø³ÙŠØ·Ø©ØŒ Ù†ÙÙ‘Ø° Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø³Ø·Ø±-Ø¨Ø³Ø·Ø±:)
if git diff --cached --quiet; then
  sed -i 's/JSON.stringify({ commands })/JSON.stringify(commands)/' src/lib/rtc/upstash.ts || true
  git add src/lib/rtc/upstash.ts
fi

echo "=== 2) Build ==="
pnpm install
pnpm build

echo "=== 3) Ù‚Ø¨ÙˆÙ„ Ø³Ø±ÙŠØ¹ Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ (Ø¥Ù†ØªØ§Ø¬) ==="
# ÙŠØ·Ø¨Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙˆÙŠØ¬Ø±ÙŠ ØªØ¯ÙÙ‚ REST Ø§Ù„ÙƒØ§Ù…Ù„
cat > _ops/acc_rtc.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail
BASE="${1:-https://www.ditonachat.com}"
say(){ printf "\n== %s ==\n" "$*"; }
code(){ curl -s -o /dev/null -w "%{http_code}" "$@"; }

TMPDIR="${TMPDIR:-/tmp}"
JAR_A="$TMPDIR/ditona_anon_A.jar"; JAR_B="$TMPDIR/ditona_anon_B.jar"
rm -f "$JAR_A" "$JAR_B"

say "1) Init anon cookies"
curl -s -c "$JAR_A" "$BASE/api/anon/init" >/dev/null
curl -s -c "$JAR_B" "$BASE/api/anon/init" >/dev/null

say "2) Queue mode"
curl -s "$BASE/api/rtc/qlen" | sed 's/.*/qlen: &/'

say "3) Enqueue A/B"
code -b "$JAR_A" -H "content-type: application/json" -X POST \
  -d '{"gender":"u","country":"US","filterGenders":"all","filterCountries":"ALL"}' \
  "$BASE/api/rtc/enqueue" | xargs echo "A enqueue:"
code -b "$JAR_B" -H "content-type: application/json" -X POST \
  -d '{"gender":"u","country":"US","filterGenders":"all","filterCountries":"ALL"}' \
  "$BASE/api/rtc/enqueue" | xargs echo "B enqueue:"

say "4) Matchmake"
R_A=$(curl -s -b "$JAR_A" -X POST "$BASE/api/rtc/matchmake"); echo "A: $R_A"
PAIR=$(echo "$R_A" | sed -n 's/.*"pairId":"\([^"]\+\)".*/\1/p')
ROLE_A=$(echo "$R_A" | sed -n 's/.*"role":"\([^"]\+\)".*/\1/p')
R_B=$(curl -s -b "$JAR_B" -X POST "$BASE/api/rtc/matchmake"); echo "B: $R_B"
PAIR_B=$(echo "$R_B" | sed -n 's/.*"pairId":"\([^"]\+\)".*/\1/p')
ROLE_B=$(echo "$R_B" | sed -n 's/.*"role":"\([^"]\+\)".*/\1/p')
echo "Expected: same pairId; roles caller/callee"
echo "Actual:   A:$PAIR ($ROLE_A)  B:$PAIR_B ($ROLE_B)"
test -n "$PAIR" && [ "$PAIR" = "$PAIR_B" ] || { echo "âœ— Matchmake failed"; exit 1; }

say "5) Offer/Answer"
code -b "$JAR_A" -H "content-type: application/json" -X POST \
  -d "{\"pairId\":\"$PAIR\",\"sdp\":\"v=0-dummy-offer\"}" \
  "$BASE/api/rtc/offer" | xargs echo "A POST /offer:"
curl -s -b "$JAR_B" "$BASE/api/rtc/offer?pairId=$PAIR" | sed 's/.*/B GET \/offer: &/'
code -b "$JAR_B" -H "content-type: application/json" -X POST \
  -d "{\"pairId\":\"$PAIR\",\"sdp\":\"v=0-dummy-answer\"}" \
  "$BASE/api/rtc/answer" | xargs echo "B POST /answer:"
curl -s -b "$JAR_A" "$BASE/api/rtc/answer?pairId=$PAIR" | sed 's/.*/A GET \/answer: &/'

say "6) ICE exchange"
code -b "$JAR_A" -H "content-type: application/json" -X POST \
  -d "{\"pairId\":\"$PAIR\",\"candidate\":{\"candidate\":\"candA\",\"sdpMid\":\"0\",\"sdpMLineIndex\":0}}" \
  "$BASE/api/rtc/ice" | xargs echo "A POST /ice:"
curl -s -b "$JAR_B" "$BASE/api/rtc/ice?pairId=$PAIR" | sed 's/.*/B GET \/ice: &/'
code -b "$JAR_B" -H "content-type: application/json" -X POST \
  -d "{\"pairId\":\"$PAIR\",\"candidate\":{\"candidate\":\"candB\",\"sdpMid\":\"0\",\"sdpMLineIndex\":0}}" \
  "$BASE/api/rtc/ice" | xargs echo "B POST /ice:"
curl -s -b "$JAR_A" "$BASE/api/rtc/ice?pairId=$PAIR" | sed 's/.*/A GET \/ice: &/'

say "SUMMARY"
echo "Expected: qlen.mode=redis, match OK, offer/answer 204/409, ice GET arrays."
SH
chmod +x _ops/acc_rtc.sh

echo "=== 4) Commit & Push ==="
git add -A
git commit -m "fix(upstash): pipeline body as JSON array; unblock Redis REST"
git push origin HEAD

echo "=== 5) Ø¨Ø¹Ø¯ Ù†Ø´Ø± VercelØŒ Ø´ØºÙ‘Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ==="
bash _ops/acc_rtc.sh https://www.ditonachat.com || (echo "ACCEPTANCE FAILED" && exit 1)

echo "=== DONE ==="

âœ… Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Expected/Actual)

qlen Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: {"mode":"redis-fail","len":0,"error":"... parse pipeline ..."}.

qlen Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: {"mode":"redis","len":<Ø¹Ø¯Ø¯>=0 Ø£Ùˆ >0} Ø¨Ø¯ÙˆÙ† error.

enqueue Ùˆ matchmake ØªØªÙˆÙ‚Ù Ø¹Ù† 500.

acc_rtc.sh: ÙŠØ¸Ù‡Ø± pairId ÙˆØ§Ø­Ø¯ Ù„Ù„Ø·Ø±ÙÙŠÙ† (caller/callee)ØŒ ÙˆÙ†Ø¬Ø§Ø­ offer/answer/ice.

Ø¨ØµØ±ÙŠÙ‹Ø§ Ù…Ù† Ø¬Ù‡Ø§Ø²ÙŠÙ†: Ø§Ù„Ø¶ØºØ· Next ÙÙŠ ÙƒÙ„ÙŠÙ‡Ù…Ø§ ÙŠÙØ·Ù„Ù‚ Ø§ØªØµØ§Ù„ ÙØ¹Ù„ÙŠ Ø®Ù„Ø§Ù„ â‰¤10 Ø«ÙˆØ§Ù†ÙŠ.

ğŸ§ª Ù„Ù…Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ´Ù„ ÙŠØ¸Ù‡Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ØŸ

Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø¯Ø§Ù„Ø© Redis Ù…Ø±ÙƒÙ‘Ø¨Ø© (Ù…Ø«Ù„ enqueue()/matchmake())ØŒ ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„ÙƒÙˆØ¯ pipe([...]).

Ø¬Ø³Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£ÙØ±Ø³ÙÙ„ ÙƒÙ€ { "commands":[...] } â†’ Upstash ÙŠÙØ±Ø¬Ø¹ 400 â€œfailed to parse pipeline requestâ€ â†’ Ø§Ù„ØªØ§Ø¨Ø¹ ÙŠØ±Ù…ÙŠ Ø§Ø³ØªØ«Ù†Ø§Ø¡ â†’ 500 ÙÙŠ Ù…Ø³Ø§Ø±Ø§ØªÙƒ.

Ù‡Ø°Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ 1:1 Ù…Ø¹ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù€ Upstash: /pipeline ÙŠÙØ³ØªÙ‚Ø¨Ù„ Ù…ØµÙÙˆÙØ© JSON Ø«Ù†Ø§Ø¦ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©. 
Upstash: Serverless Data Platform

Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±Ø£ÙŠØª ÙÙŠ ØµÙˆØ±Ùƒ Ø£Ù† /api/anon/init ÙŠØ¶Ø¨Ø· Ø§Ù„ÙƒÙˆÙƒÙŠ Ø¨Ù†Ø¬Ø§Ø­ Ùˆqlen ÙÙ‚Ø· Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠÙØ¸Ù‡Ø± (redis-fail)ØŒ ÙˆÙ‡Ø°Ø§ Ù…Ø§ Ø£ÙƒØ¯ Ø§Ù„ØªØ´Ø®ÙŠØµ.

â„¹ï¸ Ø¥Ù† Ø¸Ù‡Ø± Ø£ÙŠ ØªØ¹Ø§Ø±Ø¶ Ø·ÙÙŠÙ Ø¹Ù†Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§ØªØ´

Ù†ÙÙ‘Ø°ØªÙ Ø³Ø·Ø± Ø¨Ø¯ÙŠÙ„ Ø¨Ù€ sed Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ JSON.stringify({ commands }) Ø¨Ù€ JSON.stringify(commands) Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹.

Ø¥Ù† ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© memory fallback ÙÙŠ upstash.ts ÙÙ‡ÙŠ Ø³ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠØ› Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙÙ‚Ø· ÙŠØºÙŠÙ‘Ø± Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø³Ù… Ø¹Ù†Ø¯ ÙˆØ¶Ø¹ redis.

ğŸ“‹ Ù…Ø§ Ù†Ø­ØªØ§Ø¬Ù‡ Ù…Ù†Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°

Ø§Ù†Ø³Ø® Ù„ÙŠ Ø³Ø·Ø± /api/rtc/qlen Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø± (JSON ÙƒØ§Ù…Ù„).

ÙˆØ£Ø±Ø³Ù„ Ø®Ø±Ø¬ bash _ops/acc_rtc.sh https://www.ditonachat.com (Expected/Actual).

Ù„Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Network ØªÙØ¸Ù‡Ø±: enqueue=204, matchmake=200 {pairId,â€¦}, Ø«Ù… /offer|answer Ùˆ/ice Ù†Ø§Ø¬Ø­Ø©.