DitonaChat — UI Hotfix (Minimal-Diff) مع تحقق ونشر آمن
النطاق

لا تعديل على السيرفر/مسارات API.

تعديلات واجهة فقط على فرعك الحالي: hotfix/ui-backport-09250053.

هدفان:

ضمان التسلسل: age/allow ⇒ anon/init ⇒ emit("ui:next") مرة واحدة.

تحت FFA=1، تفعيل Prev / Filters / Beauty فوريًا على العميل.

الملفات المستهدفة

src/app/chat/ChatClient.tsx

src/app/chat/rtcFlow.ts

إن وُجدت أزرار ضمن:

src/app/chat/components/ChatToolbar.tsx

src/app/chat/components/FilterBar.tsx

أو نظائرها تحت src/components/chat/* بحسب الهيكلة الحالية. استخدم المسارات الموجودة فعليًا في الفرع.

المطلوب تنفيذُه
A) تسلسل الأوتوستارت

داخل ChatClient.tsx: قبل أول emit("ui:next") مباشرة أضِف:

try {
  const opts = { method: "POST", credentials: "include" as RequestCredentials, cache: "no-store" as RequestCache };
  await fetch("/api/anon/init", opts);
} catch (e) { console.warn("anon/init failed", e); }


ثم يبقى emit("ui:next") كما هو. لا تعتمد على document.cookie أبدًا.

B) طبقة الشبكة في العميل

في rtcFlow.ts: تأكد أن كل طلبات /api/(rtc|message|age|anon) تمر عبر safeFetch يفرض:

credentials: "include", cache: "no-store"

C) DataChannel marker

في rtcFlow.ts: تأكد من:

تعيين: globalThis.__ditonaDataChannel = dc;

بثّ: dispatchEvent(new CustomEvent("rtc:phase",{detail:{phase:"dc-open"}})); داخل dc.onopen.

D) FFA Runtime UI

على العميل فقط. احتسب:

const ffa = (typeof window!=="undefined" && (window as any).__vip?.FREE_FOR_ALL == 1);
if (ffa) console.log("FFA_FORCE: enabled");


حرّر حراس الأزرار:

Prev: disabled = !( ffa || (dc?.readyState==="open" && pairId) )

Filters/Beauty: disabled = !( ffa || dc?.readyState==="open" )

لا تستخدم process.env.NEXT_PUBLIC_FREE_FOR_ALL على العميل. القراءة من runtime فقط (window.__vip أو isFFA() إن وجدت).

E) عدم ربط فتح القناة بالكاميرا

لا تمنع بدء التدفق عند NotAllowedError للكاميرا. إن كانت دالة start(local) تشترط local، اجعلها تقبل null وتضيف التراكات فقط إن وُجدت. لا تغيّر منطق السيرفر.

تحقق محلي

ابقَ على الفرع: hotfix/ui-backport-09250053.

شغّل: pnpm lint && pnpm typecheck && pnpm build يجب أن تمر.

تحقق نصّي:

grep -n '/api/anon/init' src/app/chat/ChatClient.tsx ≥ 1

لا وجود لأي document.cookie.*anon في ChatClient.tsx

لا وجود لاستخدام NEXT_PUBLIC_FREE_FOR_ALL في src للعميل.

افتح .next/static/chunks/app/chat/page-*.js:

يجب أن يحتوي: AUTO_NEXT: fired و FFA_FORCE: enabled و dc-open.

نشر معاينة (Preview)

ادفع الفرع إلى GitHub.

أنشئ Preview Deployment على Vercel لهذا الفرع.

تحقق على الـPreview:

DevTools › Network › افتح chunk page-*.js تبويب Response.

ابحث عن AUTO_NEXT: fired وFFA_FORCE: enabled وdc-open.

Console:

يظهر FFA_FORCE: enabled.

الواجهة:

أزرار Prev/Filters/Beauty مفعّلة مباشرة تحت FFA=1 حتى بدون مطابقة.

تسليم ودمج

عند نجاح الـPreview:

افتح PR من hotfix/ui-backport-09250053 إلى main.

بعد موافقتنا: دمج إلى main ثم Production Redeploy بدون Build Cache.

تحقق على www.ditonachat.com/chat بنفس خطوات الـPreview.

معايير القبول النهائية

بناء محلي يمر: lint+typecheck+build = 1.

في chunk الإنتاج:

AUTO_NEXT: fired = موجود.

FFA_FORCE: enabled = موجود.

dc-open = موجود.

على الإنتاج وتحت FFA=1:

Prev/Filters/Beauty = Enabled فورًا.

لا وجود لاستخدام NEXT_PUBLIC_FREE_FOR_ALL على العميل.

لا تراجع في RTC: A/B عبر curl ما يزال يعطي:

enqueue = 204 للطرفين

matchmake = 200 مع found=true وpairId واحد

message/allow = 200 تحت FFA

أمان ورجوع

نقطة رجوع موجودة: safepoint-20250925-005307.

أي وقت يمكن Rollback من Vercel إلى نشر سابق.

احتفِظ بنسخة احتياطيّة للملفات التي تغيّرْتها في _ops/backups/.

إن احتجت صلاحيات أو بيانات إضافية، أبلغنا قبل التنفيذ